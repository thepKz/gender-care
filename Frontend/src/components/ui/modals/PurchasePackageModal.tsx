import { CreditCardOutlined } from '@ant-design/icons';
import { Button, Card, message, Modal, Typography } from 'antd';
import React, { useState } from 'react';
import packagePurchaseApi from '../../../api/endpoints/packagePurchaseApi';
import { ServicePackage } from '../../../types';

const { Title, Text } = Typography;

interface PurchasePackageModalProps {
  visible: boolean;
  onClose: () => void;
  servicePackage: ServicePackage | null;
  onSuccess?: () => void;
}

const PurchasePackageModal: React.FC<PurchasePackageModalProps> = ({
  visible,
  onClose,
  servicePackage,
  onSuccess
}) => {
  const [loading, setLoading] = useState(false);

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(price);
  };

  const handlePurchase = async () => {
    if (!servicePackage?._id) return;

    setLoading(true);
    try {
      console.log('üîç [Frontend] Calling purchasePackage API...');
      const response = await packagePurchaseApi.purchasePackage({
        packageId: servicePackage._id,
        // Kh√¥ng c·∫ßn g·ª≠i profileId n·ªØa
      });

      console.log('üîç [Frontend] API Response:', response);
      console.log('üîç [Frontend] Response success:', response.success);
      console.log('üîç [Frontend] Response data:', response.data);
      console.log('üîç [Frontend] Payment URL:', response.data?.bill?.paymentUrl);

      if (response.success && response.data?.bill?.paymentUrl) {
        console.log('‚úÖ [Frontend] Redirecting to PayOS:', response.data.bill.paymentUrl);
        // Redirect ƒë·∫øn PayOS payment page
        window.location.href = response.data.bill.paymentUrl;
      } else {
        console.error('‚ùå [Frontend] No payment URL in response:', response);
        message.error('Kh√¥ng th·ªÉ t·∫°o link thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    } catch (error: any) {
      console.error('‚ùå [Frontend] Error purchasing package:', error);
      console.error('‚ùå [Frontend] Error response:', error.response);
      console.error('‚ùå [Frontend] Error data:', error.response?.data);
      
      // Enhanced error handling v·ªõi user-friendly messages
      let errorMessage = 'C√≥ l·ªói x·∫£y ra khi mua g√≥i d·ªãch v·ª•';
      
      if (error.response?.data?.errors?.general) {
        const originalError = error.response.data.errors.general;
        
        // Handle specific duplicate package error
        if (originalError.includes('B·∫°n ƒë√£ s·ªü h·ªØu g√≥i n√†y')) {
          errorMessage = 'B·∫°n ƒë√£ s·ªü h·ªØu g√≥i d·ªãch v·ª• n√†y v√† v·∫´n c√≤n hi·ªáu l·ª±c. Vui l√≤ng s·ª≠ d·ª•ng h·∫øt c√°c d·ªãch v·ª• ho·∫∑c ch·ªù g√≥i h·∫øt h·∫°n tr∆∞·ªõc khi mua l·∫°i.';
          
          // Show additional info modal
          Modal.info({
            title: 'üéÅ G√≥i d·ªãch v·ª• ƒë√£ c√≥ s·∫µn',
            content: (
              <div>
                <p>B·∫°n ƒë√£ s·ªü h·ªØu g√≥i d·ªãch v·ª• n√†y v·ªõi:</p>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li>‚úÖ C√°c d·ªãch v·ª• ch∆∞a s·ª≠ d·ª•ng h·∫øt</li>
                  <li>üìÖ Th·ªùi h·∫°n c√≤n hi·ªáu l·ª±c</li>
                </ul>
                <p style={{ marginTop: '12px', fontWeight: '500' }}>
                  üí° <strong>G·ª£i √Ω:</strong> H√£y v√†o trang <em>"G√≥i ƒë√£ mua"</em> ƒë·ªÉ ƒë·∫∑t l·ªãch s·ª≠ d·ª•ng c√°c d·ªãch v·ª• c√≥ s·∫µn.
                </p>
              </div>
            ),
            okText: 'ƒê√£ hi·ªÉu',
            centered: true
          });
          
        } else if (originalError.includes('Package not found')) {
          errorMessage = 'Kh√¥ng t√¨m th·∫•y g√≥i d·ªãch v·ª• ho·∫∑c g√≥i ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông';
        } else if (originalError.includes('Insufficient payment')) {
          errorMessage = 'S·ªë ti·ªÅn thanh to√°n kh√¥ng ƒë·ªß cho g√≥i d·ªãch v·ª• n√†y';
        } else {
          errorMessage = originalError;
        }
      } else if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      message.error(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  const handleCancel = () => {
    onClose();
  };

  if (!servicePackage) return null;

  const discountPercentage = Math.round(
    ((servicePackage.priceBeforeDiscount - servicePackage.price) / servicePackage.priceBeforeDiscount) * 100
  );

  // üîπ Calculate total service quantity
  const totalQuantity = servicePackage.services?.reduce((sum, item) => sum + item.quantity, 0) || 0;

  return (
    <Modal
      title={
        <div className="flex items-center gap-2">
          <CreditCardOutlined className="text-blue-600" />
          <span>Mua g√≥i d·ªãch v·ª•</span>
        </div>
      }
      open={visible}
      onCancel={handleCancel}
      footer={null}
      width={600}
      className="purchase-package-modal"
    >
      <div className="space-y-6">
        {/* Package Info */}
        <Card className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200">
          <div className="text-center">
            <div className="text-4xl mb-3">üéÅ</div>
            <Title level={4} className="mb-2">{servicePackage.name}</Title>
            <Text className="text-gray-600 block mb-4">{servicePackage.description || 'G√≥i d·ªãch v·ª• chƒÉm s√≥c s·ª©c kh·ªèe to√†n di·ªán'}</Text>
            
            {/* üîπ Package Summary */}
            <div className="flex justify-center gap-6 mb-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">{servicePackage.services?.length || 0}</div>
                <div className="text-sm text-gray-500">D·ªãch v·ª•</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">{totalQuantity}</div>
                <div className="text-sm text-gray-500">L∆∞·ª£t s·ª≠ d·ª•ng</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">{servicePackage.durationInDays}</div>
                <div className="text-sm text-gray-500">Ng√†y</div>
              </div>
            </div>
            
            {/* Price Display */}
            <div className="space-y-2">
              {discountPercentage > 0 && (
                <div>
                  <Text delete className="text-gray-500 text-lg">
                    {formatPrice(servicePackage.priceBeforeDiscount)}
                  </Text>
                  <span className="ml-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                    -{discountPercentage}%
                  </span>
                </div>
              )}
              <div className="text-3xl font-bold text-blue-600">
                {formatPrice(servicePackage.price)}
              </div>
              {discountPercentage > 0 && (
                <Text className="text-green-600 font-medium">
                  Ti·∫øt ki·ªám {formatPrice(servicePackage.priceBeforeDiscount - servicePackage.price)}
                </Text>
              )}
            </div>
          </div>
        </Card>

        {/* Services Summary */}
        {servicePackage.services && servicePackage.services.length > 0 && (
          <Card className="bg-gray-50 border border-gray-200">
            <Title level={5} className="mb-3 text-center">Chi ti·∫øt g√≥i d·ªãch v·ª•</Title>
            <div className="space-y-2">
              {servicePackage.services.map((serviceItem, index) => {
                const service = typeof serviceItem.serviceId === 'object' ? serviceItem.serviceId : null;
                if (!service) return null;
                
                return (
                  <div key={index} className="flex items-center justify-between py-2 px-3 bg-white rounded-lg border">
                    <div className="flex items-center gap-3">
                      <span className="text-lg">ü©∫</span>
                      <div>
                        <div className="font-medium">{service.serviceName}</div>
                        <div className="text-sm text-gray-500">{formatPrice(service.price)} / l∆∞·ª£t</div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold text-blue-600">{serviceItem.quantity} l∆∞·ª£t</div>
                      <div className="text-sm text-gray-500">
                        {formatPrice(service.price * serviceItem.quantity)}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </Card>
        )}

        {/* Action Buttons */}
        <div className="flex gap-3 pt-4 border-t">
          <Button 
            size="large" 
            onClick={handleCancel}
            className="flex-1"
          >
            Hu·ª∑ b·ªè
          </Button>
          <Button
            type="primary"
            size="large"
            loading={loading}
            onClick={handlePurchase}
            className="flex-1 bg-blue-600 hover:bg-blue-700"
          >
            <CreditCardOutlined />
            Thanh to√°n v·ªõi PayOS - {formatPrice(servicePackage.price)}
          </Button>
        </div>
      </div>
    </Modal>
  );
};

export default PurchasePackageModal; 