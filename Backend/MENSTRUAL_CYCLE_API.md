# Menstrual Cycle API Documentation

## Tổng quan

API quản lý chu kỳ kinh nguyệt theo phương pháp Billings, bao gồm theo dõi 3 chu kỳ, phân tích dữ liệu, và gửi nhắc nhở hàng ngày.

**🚺 Lưu ý quan trọng:** Tính năng chu kỳ kinh nguyệt chỉ dành cho người dùng nữ (`gender: 'female'`). Hệ thống sẽ tự động kiểm tra và chỉ gửi nhắc nhở email cho user nữ có chu kỳ kinh nguyệt.

## Authentication

Tất cả endpoints đều yêu cầu JWT token trong header `Authorization: Bearer <token>`, trừ endpoint trigger reminder.

## API Endpoints

### 1. Quản lý Chu kỳ (Menstrual Cycles)

#### Tạo chu kỳ mới
```http
POST /api/menstrual-cycles
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-01"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Tạo chu kỳ mới thành công",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-01T00:00:00.000Z",
    "cycleNumber": 1,
    "status": "tracking",
    "isCompleted": false
  }
}
```

#### Lấy danh sách chu kỳ
```http
GET /api/menstrual-cycles?page=1&limit=10&status=tracking
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cycles": [...],
    "pagination": {
      "current": 1,
      "total": 5,
      "totalRecords": 42
    }
  }
}
```

#### Lấy chi tiết chu kỳ
```http
GET /api/menstrual-cycles/:id
Authorization: Bearer <token>
```

#### Lấy dữ liệu calendar
```http
GET /api/menstrual-cycles/calendar?month=1&year=2024
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "month": 1,
    "year": 2024,
    "days": [
      {
        "date": "2024-01-01T00:00:00.000Z",
        "symbol": "M",
        "isPeakDay": false,
        "fertilityProbability": 0,
        "mucusObservation": "có máu",
        "feeling": "ướt",
        "notes": "Ngày đầu chu kỳ",
        "isValidated": true,
        "warning": null
      }
    ]
  }
}
```

#### Cập nhật chu kỳ
```http
PUT /api/menstrual-cycles/:id
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-05",  // Cập nhật ngày bắt đầu chu kỳ (tùy chọn)
  "endDate": "2024-01-28",    // Ngày kết thúc chu kỳ (tùy chọn)
  "isCompleted": true,        // Đánh dấu chu kỳ hoàn thành (tùy chọn)
  "status": "completed"       // Trạng thái: "tracking", "completed", "analysis" (tùy chọn)
}
```

**Lưu ý quan trọng về startDate:**
- Khi cập nhật `startDate`, hệ thống sẽ tự động tính toán lại `cycleDayNumber` cho tất cả ngày đã ghi nhận trong chu kỳ
- Điều này hữu ích khi phát hiện ngày đầu kinh nguyệt thực tế khác với ngày đã đặt ban đầu
- Ví dụ: Nếu bạn đặt ngày bắt đầu là 15/1 nhưng sau đó nhận ra ngày 12/1 mới là ngày đầu thật sự

**Response:**
```json
{
  "success": true,
  "message": "Cập nhật chu kỳ thành công",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-05T00:00:00.000Z",
    "endDate": "2024-01-28T00:00:00.000Z",
    "isCompleted": true,
    "status": "completed"
  }
}
```

### 2. Quản lý Ngày trong Chu kỳ (Cycle Days)

#### Thêm/cập nhật dữ liệu ngày
```http
POST /api/cycle-days
Content-Type: application/json
Authorization: Bearer <token>

{
  "cycleId": "cycle_id",
  "date": "2024-01-15",
  "mucusObservation": "trong và âm hộ căng",
  "feeling": "trơn",
  "notes": "Cảm giác có thể là ngày X"
}
```

**Mucus Observations:**
- `có máu`
- `lấm tấm máu`
- `đục`
- `đục nhiều sợi`
- `trong nhiều sợi`
- `trong và âm hộ căng` (ngày X)
- `dầy`
- `ít chất tiết`

**Feelings:**
- `ướt`
- `dính`
- `ẩm`
- `khô`
- `trơn`

**Response:**
```json
{
  "success": true,
  "message": "Cập nhật dữ liệu ngày thành công",
  "data": {
    "_id": "day_id",
    "cycleId": "cycle_id",
    "date": "2024-01-15T00:00:00.000Z",
    "mucusObservation": "trong và âm hộ căng",
    "feeling": "trơn",
    "isPeakDay": true,
    "peakDayRelative": 0,
    "fertilityProbability": 100,
    "isValidated": true,
    "isAutoGenerated": false,
    "cycleDayNumber": 15,
    "month": 1,
    "year": 2024
  }
}
```

#### Xóa dữ liệu ngày
```http
DELETE /api/cycle-days/:id
Authorization: Bearer <token>
```

### 3. Báo cáo và Phân tích

#### Tạo báo cáo chu kỳ
```http
POST /api/reports/generate/:cycleId
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Tạo báo cáo chu kỳ thành công",
  "data": {
    "_id": "report_id",
    "cycleId": "cycle_id",
    "x": "2024-01-15T00:00:00.000Z",
    "xPlusOne": "2024-01-16T00:00:00.000Z",
    "y": "2024-01-28T00:00:00.000Z",
    "result": -12,
    "resultType": "normal",
    "analysis": {
      "peakDayDetected": true,
      "postPeakDaysAnalyzed": 3,
      "fertilityWindowStart": "2024-01-13T00:00:00.000Z",
      "fertilityWindowEnd": "2024-01-18T00:00:00.000Z"
    }
  }
}
```

#### Lấy báo cáo chu kỳ
```http
GET /api/reports/:cycleId
Authorization: Bearer <token>
```

#### So sánh 3 chu kỳ
```http
GET /api/reports/comparison
Authorization: Bearer <token>
```

### 4. Phân tích Chu kỳ Hoàn chỉnh (Cycle Analysis)

#### Lấy báo cáo phân tích chu kỳ
```http
GET /api/menstrual-cycles/:id/analysis
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Lấy báo cáo phân tích chu kỳ thành công",
  "data": {
    "cycleId": "cycle_id",
    "cycleNumber": 1,
    "startDate": "2024-01-01T00:00:00.000Z",
    "endDate": null,
    "isCompleted": false,
    "analysis": {
      "isComplete": false,
      "analysis": "Đã có kinh nguyệt, đang chờ ngày đỉnh (trong và âm hộ căng).",
      "phase": "pre_peak_tracking",
      "peakDay": null,
      "pattern": {
        "type": "unknown_pattern",
        "name": "Mẫu chưa rõ ràng",
        "description": "Cần thêm dữ liệu để phân tích",
        "confidence": "unknown"
      },
      "nextPeakPrediction": {
        "prediction": null,
        "confidence": "none",
        "message": "Chưa xác định được ngày đỉnh của chu kỳ hiện tại"
      },
      "recommendations": [
        "📈 Cần thêm dữ liệu để phân tích chu kỳ",
        "🎯 Hãy ghi nhận đầy đủ thông tin mỗi ngày"
      ]
    }
  }
}
```

**Các loại mẫu chu kỳ (Pattern Types):**
- `normal_pattern`: Chu kỳ bình thường (Máu → Lấm tấm máu → Khô → Đục → Trong âm hộ căng)
- `irregular_pattern`: Chu kỳ cần theo dõi (Lấm tấm máu → Ít chất tiết)
- `unknown_pattern`: Mẫu chưa rõ ràng

**Các giai đoạn chu kỳ (Phases):**
- `no_data`: Chưa có dữ liệu
- `initial_tracking`: Đang theo dõi ban đầu
- `pre_peak_tracking`: Đã có kinh nguyệt, chờ ngày đỉnh
- `post_peak_tracking`: Đã qua ngày đỉnh, chờ ngày khô
- `completed`: Chu kỳ hoàn chỉnh
- `needs_observation`: Cần theo dõi thêm

#### Tự động hoàn thành chu kỳ
```http
POST /api/menstrual-cycles/:id/auto-complete
Authorization: Bearer <token>
```

#### Lấy hướng dẫn chi tiết về chu kỳ hiện tại
```http
GET /api/menstrual-cycles/:id/guidance
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Lấy hướng dẫn chu kỳ thành công",
  "data": {
    "cycleId": "cycle_id",
    "cycleNumber": 1,
    "startDate": "2024-01-01T00:00:00.000Z",
    "isCompleted": false,
    "currentPhase": "post_peak_tracking",
    "analysis": "Đã qua ngày đỉnh. Cần theo dõi thêm 2 ngày để hoàn thành chu kỳ.",
    "status": "critical",
    "title": "⏰ Đang theo dõi sau ngày đỉnh",
    "description": "Đã qua ngày đỉnh. Cần theo dõi thêm 2 ngày để hoàn thành chu kỳ.",
    "peakDay": "2024-01-14T00:00:00.000Z",
    "actions": [
      {
        "type": "continue",
        "text": "Tiếp tục ghi nhận 2 ngày nữa",
        "priority": "high"
      },
      {
        "type": "observe",
        "text": "Chú ý sự chuyển đổi sang trạng thái khô",
        "priority": "medium"
      }
    ],
    "tips": [
      "Đây là giai đoạn quan trọng để xác định chu kỳ hoàn chỉnh",
      "Ghi nhận chính xác cảm giác \"khô\" hoặc \"ít chất tiết\"",
      "Không bỏ sót bất kỳ ngày nào trong giai đoạn này"
    ]
  }
}
```

**Response khi chu kỳ đủ điều kiện:**
```json
{
  "success": true,
  "message": "Chu kỳ đã được đánh dấu hoàn thành",
  "data": {
    "cycle": {
      "_id": "cycle_id",
      "isCompleted": true,
      "status": "completed",
      "peakDay": "2024-01-15T00:00:00.000Z"
    },
    "analysis": {
      "isComplete": true,
      "analysis": "Chu kỳ hoàn chỉnh. Ngày đỉnh: 15. Thời gian khô sau đỉnh: 3 ngày."
    }
  }
}
```

**Response khi chu kỳ chưa đủ điều kiện:**
```json
{
  "success": false,
  "message": "Chu kỳ chưa đủ điều kiện để hoàn thành",
  "data": {
    "analysis": {
      "isComplete": false,
      "phase": "post_peak_tracking",
      "analysis": "Đã qua ngày đỉnh (ngày 15). Cần theo dõi thêm 1 ngày khô để hoàn thành chu kỳ."
    }
  }
}
```

## Logic Phân tích Chu kỳ theo Phương pháp Billings - CẬP NHẬT MỚI

### Định nghĩa Chu kỳ Hoàn chỉnh

Một chu kỳ kinh nguyệt được coi là **hoàn chỉnh** khi có đầy đủ các giai đoạn theo đúng trình tự:

1. **Bắt đầu**: Cảm giác chất nhờn là máu (`có máu`)
2. **Tùy chọn**: Lấm tấm máu 
3. **Ngày đỉnh**: Cảm giác chất nhờn là `trong và âm hộ căng` + cảm giác `trơn`
4. **Kết thúc**: Cảm giác chất nhờn là khô (`khô` hoặc `ít chất tiết`) sau ít nhất 3 ngày sau đỉnh

### Hai Trường hợp Hoàn thành Chu kỳ

#### **Trường hợp 1: Hoàn thành trong cùng tháng**
```
Diễn biến: Máu → [Lấm tấm] → Khô → Đục → Ngày đỉnh → 3 ngày sau đỉnh khô → Máu mới
Thời gian: Tất cả diễn ra trong 1 tháng
Điều kiện: Sau ngày 1,2,3 sau ngày đỉnh là khô → có máu chu kỳ mới
```

**Ví dụ:**
- Ngày 1-5: Có máu kinh nguyệt
- Ngày 6-7: Lấm tấm máu (optional)
- Ngày 8-10: Khô (`ít chất tiết`, `khô`)
- Ngày 11-12: Đục
- Ngày 14: Ngày đỉnh (`trong và âm hộ căng`, `trơn`)
- Ngày 15-17: 3 ngày sau đỉnh (ngày 17 = khô)
- Ngày 18-28: Tiếp tục khô
- **Ngày 29: Máu mới → CHU KỲ HOÀN CHỈNH**

#### **Trường hợp 2: Lấn sang tháng sau**
```
Diễn biến: Máu → [Lấm tấm] → Khô → Đục → Ngày đỉnh → 3 ngày sau đỉnh vẫn ít chất tiết
Thời gian: Lấn sang tháng sau do chưa chuyển sang khô hoàn toàn
Điều kiện: Sau ngày 1,2,3 sau ngày đỉnh vẫn ít chất tiết, chưa chuyển sang khô
```

**Ví dụ:**
- Ngày 15-17 tháng 1: Có máu kinh nguyệt
- Ngày 18-19 tháng 1: Lấm tấm máu
- Ngày 20-21 tháng 1: Khô
- Ngày 22-23 tháng 1: Đục
- Ngày 26 tháng 1: Ngày đỉnh
- Ngày 27-31 tháng 1: 3 ngày sau đỉnh vẫn `ít chất tiết`
- **Ngày 1-5 tháng 2: Vẫn `ít chất tiết`, chưa khô hoàn toàn**
- **Cần theo dõi thêm đến khi chuyển sang khô**

### API Response mới

#### Khi chu kỳ hoàn chỉnh (Trường hợp 1):
```json
{
  "success": true,
  "message": "Chu kỳ đã hoàn thành và tự động tạo chu kỳ mới",
  "data": {
    "completedCycle": {
      "_id": "cycle_id",
      "isCompleted": true,
      "status": "completed",
      "endDate": "2024-01-28T00:00:00.000Z"
    },
    "newCycle": {
      "_id": "new_cycle_id",
      "startDate": "2024-01-29T00:00:00.000Z",
      "cycleNumber": 2
    },
    "analysis": {
      "isComplete": true,
      "phase": "completed_case_1",
      "analysis": "Chu kỳ hoàn chỉnh (Trường hợp 1 - trong cùng tháng). Ngày đỉnh: 14/1/2024. Chu kỳ dài 28 ngày.",
      "cycleType": "same_month_completion",
      "cycleLength": 28,
      "nextCycleStart": "2024-01-29T00:00:00.000Z"
    }
  }
}
```

#### Khi chu kỳ chưa hoàn chỉnh (Trường hợp 2):
```json
{
  "success": false,
  "message": "Chu kỳ chưa đủ điều kiện để hoàn thành",
  "data": {
    "analysis": {
      "isComplete": false,
      "phase": "cross_month_drying",
      "analysis": "Trường hợp 2 - Lấn sang tháng sau. Ngày 3 sau đỉnh vẫn có ít chất tiết. Cần tiếp tục theo dõi đến khi chuyển sang trạng thái khô.",
      "cycleType": "cross_month_incomplete",
      "peakDay": {
        "date": "2024-01-26T00:00:00.000Z",
        "cycleDayNumber": 12
      }
    },
    "phase": "cross_month_drying",
    "guidance": "Chu kỳ đã lấn sang tháng sau. Tiếp tục theo dõi cho đến khi hoàn toàn khô.",
    "currentStatus": "Trường hợp 2 - Lấn sang tháng sau. Ngày 3 sau đỉnh vẫn có ít chất tiết."
  }
}
```

### Các Giai đoạn Chu kỳ Mới

| Giai đoạn | Mô tả | Hành động |
|-----------|-------|-----------|
| `waiting_for_menstruation` | Chưa có máu kinh nguyệt | Ghi nhận ngày đầu có máu |
| `pre_peak_tracking` | Đã có máu, chờ ngày đỉnh | Theo dõi đến khi có `trong và âm hộ căng` |
| `post_peak_tracking` | Sau ngày đỉnh, chờ đủ 3 ngày | Theo dõi thêm X ngày |
| `waiting_for_next_menstruation` | Đã khô 3 ngày, chờ máu mới | Chờ kinh nguyệt chu kỳ tiếp theo |
| `cross_month_drying` | Lấn sang tháng, đã tìm thấy ngày khô | Theo dõi thêm để xác nhận |
| `extended_post_peak_tracking` | Lấn sang tháng, vẫn chưa khô | Tiếp tục theo dõi đến khi khô |
| `completed_case_1` | ✅ Hoàn thành Trường hợp 1 | Tự động tạo chu kỳ mới |
| `completed_case_2` | ✅ Hoàn thành Trường hợp 2 | Đánh dấu hoàn thành |

### Hướng dẫn Sử dụng

1. **Theo dõi hàng ngày**: Ghi nhận đầy đủ `mucusObservation` và `feeling` mỗi ngày

2. **Kiểm tra trạng thái**: Gọi API `GET /api/menstrual-cycles/:id/analysis` để xem trạng thái hiện tại

3. **Tự động hoàn thành**: Gọi API `POST /api/menstrual-cycles/:id/auto-complete` khi muốn kiểm tra điều kiện hoàn thành

4. **Xử lý Trường hợp 2**: Khi chu kỳ lấn sang tháng sau, tiếp tục theo dõi cho đến khi hoàn toàn khô

### Quy tắc Validation Quan trọng

- **Ngày đỉnh**: Phải có `mucusObservation = "trong và âm hộ căng"` + `feeling = "trơn"`
- **3 ngày sau đỉnh**: Phải có ít nhất 3 ngày liên tiếp sau ngày đỉnh
- **Ngày khô**: `feeling = "khô"` hoặc `mucusObservation = "ít chất tiết"`
- **Chu kỳ mới**: Chỉ tự động tạo khi có máu mới xuất hiện (Trường hợp 1)

### Ví dụ Thực tế

#### Trường hợp 1 - Thành công:
```bash
# Ghi nhận đủ dữ liệu từ ngày 1-29 tháng 1
# Ngày 14: Ngày đỉnh
# Ngày 17: Ngày 3 sau đỉnh = khô
# Ngày 29: Máu mới xuất hiện

POST /api/menstrual-cycles/cycle_id/auto-complete
# Response: success = true, tự động tạo chu kỳ mới
```

#### Trường hợp 2 - Cần theo dõi thêm:
```bash
# Ghi nhận dữ liệu từ 15/1 đến 5/2
# Ngày 26/1: Ngày đỉnh  
# Ngày 29/1: Ngày 3 sau đỉnh vẫn có ít chất tiết
# Lấn sang tháng 2 và vẫn chưa khô hoàn toàn

POST /api/menstrual-cycles/cycle_id/auto-complete
# Response: success = false, cần theo dõi thêm
```

## 5. Hệ thống Nhắc nhở (Reminder System)

### Cài đặt nhắc nhở
```http
PUT /api/reminders
Content-Type: application/json
Authorization: Bearer <token>

{
  "reminderEnabled": true,
  "reminderTime": "20:00"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Cập nhật cài đặt nhắc nhở thành công",
  "data": {
    "_id": "reminder_id",
    "userId": "user_id",
    "reminderEnabled": true,
    "reminderTime": "20:00",
    "lastNotifiedAt": null
  }
}
```

### Lấy cài đặt nhắc nhở
```http
GET /api/reminders
Authorization: Bearer <token>
```

### Test gửi email nhắc nhở
```http
POST /api/reminders/test-email
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Email nhắc nhở test đã được gửi thành công",
  "data": {
    "userId": "user_id",
    "email": "user@example.com",
    "sentAt": "2024-01-15T10:30:00.000Z"
  }
}
```

### Trigger nhắc nhở cho tất cả users (Admin/Cronjob)
```http
POST /api/reminders/notify
```

**Lưu ý:** Endpoint này không yêu cầu authentication để có thể được gọi bởi cronjob.

**Response:**
```json
{
  "success": true,
  "message": "Đã gửi nhắc nhở thành công",
  "data": {
    "notified": 15,
    "skipped": 8,
    "errors": 0
  }
}
```

### Thống kê nhắc nhở (Admin)
```http
GET /api/reminders/stats
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "totalUsers": 23,
    "enabledUsers": 18,
    "disabledUsers": 5,
    "popularReminderTimes": [
      { "_id": "20:00", "count": 8 },
      { "_id": "19:00", "count": 5 },
      { "_id": "21:00", "count": 3 }
    ]
  }
}
```

## Hệ thống Email Nhắc nhở

### Tính năng
- **Tự động gửi email** vào thời gian đã đặt hàng ngày
- **Kiểm tra trước khi gửi** xem user đã cập nhật dữ liệu hôm nay chưa
- **Email template đẹp** với thông tin hữu ích về việc theo dõi chu kỳ
- **Link trực tiếp** đến trang cập nhật chu kỳ
- **Cài đặt linh hoạt** cho từng user

### Cách hoạt động
1. **Cronjob chạy mỗi phút** để kiểm tra thời gian nhắc nhở
2. **Tìm users** có `reminderEnabled: true` và `reminderTime` trùng với thời gian hiện tại
3. **Kiểm tra** xem user đã cập nhật dữ liệu chu kỳ hôm nay chưa
4. **Gửi email** nếu chưa cập nhật
5. **Cập nhật** `lastNotifiedAt` để tránh gửi trùng lặp

### Cấu hình Email
Email sử dụng **Gmail SMTP** với các biến môi trường:
- `MAIL_USER`: Email Gmail
- `MAIL_PASSWORD`: App Password của Gmail
- `FRONTEND_URL`: URL frontend để tạo link trong email