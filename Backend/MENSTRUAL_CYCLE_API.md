# Menstrual Cycle API Documentation

## Tổng quan

API quản lý chu kỳ kinh nguyệt theo phương pháp Billings, bao gồm theo dõi 3 chu kỳ, phân tích dữ liệu, và gửi nhắc nhở hàng ngày.

## Authentication

Tất cả endpoints đều yêu cầu JWT token trong header `Authorization: Bearer <token>`, trừ endpoint trigger reminder.

## API Endpoints

### 1. Quản lý Chu kỳ (Menstrual Cycles)

#### Tạo chu kỳ mới
```http
POST /api/menstrual-cycles
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-01"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Tạo chu kỳ mới thành công",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-01T00:00:00.000Z",
    "cycleNumber": 1,
    "status": "tracking",
    "isCompleted": false
  }
}
```

#### Lấy danh sách chu kỳ
```http
GET /api/menstrual-cycles?page=1&limit=10&status=tracking
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cycles": [...],
    "pagination": {
      "current": 1,
      "total": 5,
      "totalRecords": 42
    }
  }
}
```

#### Lấy chi tiết chu kỳ
```http
GET /api/menstrual-cycles/:id
Authorization: Bearer <token>
```

#### Lấy dữ liệu calendar
```http
GET /api/menstrual-cycles/calendar?month=1&year=2024
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "month": 1,
    "year": 2024,
    "days": [
      {
        "date": "2024-01-01T00:00:00.000Z",
        "symbol": "M",
        "isPeakDay": false,
        "fertilityProbability": 0,
        "mucusObservation": "có máu",
        "feeling": "ướt",
        "notes": "Ngày đầu chu kỳ",
        "isValidated": true,
        "warning": null
      }
    ]
  }
}
```

### 2. Quản lý Ngày trong Chu kỳ (Cycle Days)

#### Thêm/cập nhật dữ liệu ngày
```http
POST /api/cycle-days
Content-Type: application/json
Authorization: Bearer <token>

{
  "cycleId": "cycle_id",
  "date": "2024-01-15",
  "mucusObservation": "trong và âm hộ căng",
  "feeling": "trơn",
  "notes": "Cảm giác có thể là ngày X"
}
```

**Mucus Observations:**
- `có máu`
- `lấm tấm máu`
- `đục`
- `đục nhiều sợi`
- `trong nhiều sợi`
- `trong và âm hộ căng` (ngày X)
- `dầy`
- `ít chất tiết`

**Feelings:**
- `ướt`
- `dính`
- `ẩm`
- `khô`
- `trơn`

**Response:**
```json
{
  "success": true,
  "message": "Cập nhật dữ liệu ngày thành công",
  "data": {
    "_id": "day_id",
    "cycleId": "cycle_id",
    "date": "2024-01-15T00:00:00.000Z",
    "mucusObservation": "trong và âm hộ căng",
    "feeling": "trơn",
    "isPeakDay": true,
    "peakDayRelative": 0,
    "fertilityProbability": 100,
    "isValidated": true,
    "isAutoGenerated": false,
    "cycleDayNumber": 15,
    "month": 1,
    "year": 2024
  }
}
```

#### Xóa dữ liệu ngày
```http
DELETE /api/cycle-days/:id
Authorization: Bearer <token>
```

### 3. Báo cáo và Phân tích

#### Tạo báo cáo chu kỳ
```http
POST /api/reports/generate/:cycleId
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Tạo báo cáo chu kỳ thành công",
  "data": {
    "_id": "report_id",
    "cycleId": "cycle_id",
    "x": "2024-01-15T00:00:00.000Z",
    "xPlusOne": "2024-01-16T00:00:00.000Z",
    "y": "2024-01-28T00:00:00.000Z",
    "result": -12,
    "resultType": "normal",
    "analysis": {
      "peakDayDetected": true,
      "postPeakDaysAnalyzed": 3,
      "fertilityWindowStart": "2024-01-13T00:00:00.000Z",
      "fertilityWindowEnd": "2024-01-18T00:00:00.000Z"
    }
  }
}
```

#### Lấy báo cáo chu kỳ
```http
GET /api/reports/:cycleId
Authorization: Bearer <token>
```

#### So sánh 3 chu kỳ
```http
GET /api/reports/comparison
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cycles": [...],
    "reports": [...],
    "analysis": {
      "cycleConsistency": "Chu kỳ ổn định",
      "averageResult": -13.5,
      "recommendation": "Chu kỳ trong giới hạn bình thường. Tiếp tục theo dõi đều đặn."
    }
  }
}
```

### 4. Nhắc nhở (Reminders)

#### Lấy cài đặt nhắc nhở
```http
GET /api/reminders
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "_id": "reminder_id",
    "userId": "user_id",
    "reminderEnabled": true,
    "reminderTime": "20:00",
    "lastNotifiedAt": "2024-01-14T20:00:00.000Z"
  }
}
```

#### Cập nhật cài đặt nhắc nhở
```http
PUT /api/reminders
Content-Type: application/json
Authorization: Bearer <token>

{
  "reminderEnabled": true,
  "reminderTime": "21:00"
}
```

#### Trigger nhắc nhở thủ công (cho cronjob)
```http
POST /api/reminders/notify
```

**Response:**
```json
{
  "success": true,
  "message": "Đã gửi nhắc nhở thành công",
  "data": {
    "notified": 15,
    "skipped": 8,
    "errors": 0
  }
}
```

#### Thống kê reminder (Admin)
```http
GET /api/reminders/stats
Authorization: Bearer <token>
```

## Validation Rules

### Mucus/Feeling Combinations
Theo phương pháp Billings, các combination hợp lệ:

- `có máu` → `ướt`
- `lấm tấm máu` → `ướt`
- `đục` → `dính`, `ẩm`
- `đục nhiều sợi` → `ướt`, `trơn`
- `trong nhiều sợi` → `ướt`, `trơn`
- `trong và âm hộ căng` → `trơn` (ngày X)
- `ít chất tiết` → `ẩm`, `ướt`

### Automatic Processing

#### Khi detect ngày X (`trong và âm hộ căng` + `trơn`):
1. Đánh dấu là ngày đỉnh (peak day)
2. Tự động tạo 3 ngày sau:
   - Ngày 1: 75% khả năng có thai, gợi ý bé trai
   - Ngày 2: 50% khả năng có thai, gợi ý bé trai  
   - Ngày 3: 20% khả năng có thai
3. Phân tích 7 ngày trước ngày X:
   - 2 ngày trước: 50-70% khả năng có thai, gợi ý bé gái

### Cycle Analysis

#### Result Calculation:
- `result = (X+1) - Y`
- X: ngày đỉnh
- Y: ngày trước khi có máu chu kỳ tiếp theo

#### Result Types:
- `normal`: result trong khoảng [-16, -11] hoặc [11, 16]
- `short`: result < 11 và > -11
- `long`: result > 16 hoặc < -16

## Calendar Symbols

- `M`: Có máu
- `m`: Lấm tấm máu
- `X`: Ngày đỉnh
- `1,2,3`: Ngày sau đỉnh
- `C`: Đục
- `S`: Trong nhiều sợi
- `D`: Khô
- `•`: Mặc định

## Error Handling

Tất cả API đều trả về format nhất quán:

**Success:**
```json
{
  "success": true,
  "message": "...",
  "data": {...}
}
```

**Error:**
```json
{
  "success": false,
  "message": "Error message",
  "errors": {...} // Validation errors
}
```

**HTTP Status Codes:**
- `200`: Success
- `201`: Created
- `400`: Bad Request / Validation Error
- `401`: Unauthorized
- `404`: Not Found
- `500`: Server Error

## Cronjob Setup

Để setup reminder tự động, tạo cronjob:

```bash
# Chạy mỗi tối 8h để gửi nhắc nhở
0 20 * * * curl -X POST http://your-api-domain/api/reminders/notify
```

## Testing Examples

### Workflow hoàn chỉnh:

1. **Tạo chu kỳ mới:**
```bash
curl -X POST http://localhost:5000/api/menstrual-cycles \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"startDate": "2024-01-01"}'
```

2. **Thêm dữ liệu hàng ngày:**
```bash
curl -X POST http://localhost:5000/api/cycle-days \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "cycleId": "cycle_id",
    "date": "2024-01-15",
    "mucusObservation": "trong và âm hộ căng",
    "feeling": "trơn"
  }'
```

3. **Xem calendar:**
```bash
curl "http://localhost:5000/api/menstrual-cycles/calendar?month=1&year=2024" \
  -H "Authorization: Bearer <token>"
```

4. **Tạo báo cáo:**
```bash
curl -X POST http://localhost:5000/api/reports/generate/cycle_id \
  -H "Authorization: Bearer <token>"
```

5. **So sánh 3 chu kỳ:**
```bash
curl http://localhost:5000/api/reports/comparison \
  -H "Authorization: Bearer <token>"
``` 