# Menstrual Cycle API Documentation

## Tổng quan

API quản lý chu kỳ kinh nguyệt theo phương pháp Billings, bao gồm theo dõi 3 chu kỳ, phân tích dữ liệu, và gửi nhắc nhở hàng ngày.

## Authentication

Tất cả endpoints đều yêu cầu JWT token trong header `Authorization: Bearer <token>`, trừ endpoint trigger reminder.

## API Endpoints

### 1. Quản lý Chu kỳ (Menstrual Cycles)

#### Tạo chu kỳ mới
```http
POST /api/menstrual-cycles
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-01"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Tạo chu kỳ mới thành công",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-01T00:00:00.000Z",
    "cycleNumber": 1,
    "status": "tracking",
    "isCompleted": false
  }
}
```

#### Lấy danh sách chu kỳ
```http
GET /api/menstrual-cycles?page=1&limit=10&status=tracking
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cycles": [...],
    "pagination": {
      "current": 1,
      "total": 5,
      "totalRecords": 42
    }
  }
}
```

#### Lấy chi tiết chu kỳ
```http
GET /api/menstrual-cycles/:id
Authorization: Bearer <token>
```

#### Lấy dữ liệu calendar
```http
GET /api/menstrual-cycles/calendar?month=1&year=2024
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "month": 1,
    "year": 2024,
    "days": [
      {
        "date": "2024-01-01T00:00:00.000Z",
        "symbol": "M",
        "isPeakDay": false,
        "fertilityProbability": 0,
        "mucusObservation": "có máu",
        "feeling": "ướt",
        "notes": "Ngày đầu chu kỳ",
        "isValidated": true,
        "warning": null
      }
    ]
  }
}
```

#### Cập nhật chu kỳ
```http
PUT /api/menstrual-cycles/:id
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-05",  // Cập nhật ngày bắt đầu chu kỳ (tùy chọn)
  "endDate": "2024-01-28",    // Ngày kết thúc chu kỳ (tùy chọn)
  "isCompleted": true,        // Đánh dấu chu kỳ hoàn thành (tùy chọn)
  "status": "completed"       // Trạng thái: "tracking", "completed", "analysis" (tùy chọn)
}
```

**Lưu ý quan trọng về startDate:**
- Khi cập nhật `startDate`, hệ thống sẽ tự động tính toán lại `cycleDayNumber` cho tất cả ngày đã ghi nhận trong chu kỳ
- Điều này hữu ích khi phát hiện ngày đầu kinh nguyệt thực tế khác với ngày đã đặt ban đầu
- Ví dụ: Nếu bạn đặt ngày bắt đầu là 15/1 nhưng sau đó nhận ra ngày 12/1 mới là ngày đầu thật sự

**Response:**
```json
{
  "success": true,
  "message": "Cập nhật chu kỳ thành công",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-05T00:00:00.000Z",
    "endDate": "2024-01-28T00:00:00.000Z",
    "isCompleted": true,
    "status": "completed"
  }
}
```

### 2. Quản lý Ngày trong Chu kỳ (Cycle Days)

#### Thêm/cập nhật dữ liệu ngày
```http
POST /api/cycle-days
Content-Type: application/json
Authorization: Bearer <token>

{
  "cycleId": "cycle_id",
  "date": "2024-01-15",
  "mucusObservation": "trong và âm hộ căng",
  "feeling": "trơn",
  "notes": "Cảm giác có thể là ngày X"
}
```

**Mucus Observations:**
- `có máu`
- `lấm tấm máu`
- `đục`
- `đục nhiều sợi`
- `trong nhiều sợi`
- `trong và âm hộ căng` (ngày X)
- `dầy`
- `ít chất tiết`

**Feelings:**
- `ướt`
- `dính`
- `ẩm`
- `khô`
- `trơn`

**Response:**
```json
{
  "success": true,
  "message": "Cập nhật dữ liệu ngày thành công",
  "data": {
    "_id": "day_id",
    "cycleId": "cycle_id",
    "date": "2024-01-15T00:00:00.000Z",
    "mucusObservation": "trong và âm hộ căng",
    "feeling": "trơn",
    "isPeakDay": true,
    "peakDayRelative": 0,
    "fertilityProbability": 100,
    "isValidated": true,
    "isAutoGenerated": false,
    "cycleDayNumber": 15,
    "month": 1,
    "year": 2024
  }
}
```

#### Xóa dữ liệu ngày
```http
DELETE /api/cycle-days/:id
Authorization: Bearer <token>
```

### 3. Báo cáo và Phân tích

#### Tạo báo cáo chu kỳ
```http
POST /api/reports/generate/:cycleId
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Tạo báo cáo chu kỳ thành công",
  "data": {
    "_id": "report_id",
    "cycleId": "cycle_id",
    "x": "2024-01-15T00:00:00.000Z",
    "xPlusOne": "2024-01-16T00:00:00.000Z",
    "y": "2024-01-28T00:00:00.000Z",
    "result": -12,
    "resultType": "normal",
    "analysis": {
      "peakDayDetected": true,
      "postPeakDaysAnalyzed": 3,
      "fertilityWindowStart": "2024-01-13T00:00:00.000Z",
      "fertilityWindowEnd": "2024-01-18T00:00:00.000Z"
    }
  }
}
```

#### Lấy báo cáo chu kỳ
```http
GET /api/reports/:cycleId
Authorization: Bearer <token>
```

#### So sánh 3 chu kỳ
```http
GET /api/reports/comparison
Authorization: Bearer <token>
```

### 4. Phân tích Chu kỳ Hoàn chỉnh (Cycle Analysis)

#### Lấy báo cáo phân tích chu kỳ
```http
GET /api/menstrual-cycles/:id/analysis
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Lấy báo cáo phân tích chu kỳ thành công",
  "data": {
    "cycleId": "cycle_id",
    "cycleNumber": 1,
    "startDate": "2024-01-01T00:00:00.000Z",
    "endDate": null,
    "isCompleted": false,
    "analysis": {
      "isComplete": false,
      "analysis": "Đã có kinh nguyệt, đang chờ ngày đỉnh (trong và âm hộ căng).",
      "phase": "pre_peak_tracking",
      "peakDay": null,
      "pattern": {
        "type": "unknown_pattern",
        "name": "Mẫu chưa rõ ràng",
        "description": "Cần thêm dữ liệu để phân tích",
        "confidence": "unknown"
      },
      "nextPeakPrediction": {
        "prediction": null,
        "confidence": "none",
        "message": "Chưa xác định được ngày đỉnh của chu kỳ hiện tại"
      },
      "recommendations": [
        "📈 Cần thêm dữ liệu để phân tích chu kỳ",
        "🎯 Hãy ghi nhận đầy đủ thông tin mỗi ngày"
      ]
    }
  }
}
```

**Các loại mẫu chu kỳ (Pattern Types):**
- `normal_pattern`: Chu kỳ bình thường (Máu → Lấm tấm máu → Khô → Đục → Trong âm hộ căng)
- `irregular_pattern`: Chu kỳ cần theo dõi (Lấm tấm máu → Ít chất tiết)
- `unknown_pattern`: Mẫu chưa rõ ràng

**Các giai đoạn chu kỳ (Phases):**
- `no_data`: Chưa có dữ liệu
- `initial_tracking`: Đang theo dõi ban đầu
- `pre_peak_tracking`: Đã có kinh nguyệt, chờ ngày đỉnh
- `post_peak_tracking`: Đã qua ngày đỉnh, chờ ngày khô
- `completed`: Chu kỳ hoàn chỉnh
- `needs_observation`: Cần theo dõi thêm

#### Tự động hoàn thành chu kỳ
```http
POST /api/menstrual-cycles/:id/auto-complete
Authorization: Bearer <token>
```

**Response khi chu kỳ đủ điều kiện:**
```json
{
  "success": true,
  "message": "Chu kỳ đã được đánh dấu hoàn thành",
  "data": {
    "cycle": {
      "_id": "cycle_id",
      "isCompleted": true,
      "status": "completed",
      "peakDay": "2024-01-15T00:00:00.000Z"
    },
    "analysis": {
      "isComplete": true,
      "analysis": "Chu kỳ hoàn chỉnh. Ngày đỉnh: 15. Thời gian khô sau đỉnh: 3 ngày."
    }
  }
}
```

**Response khi chu kỳ chưa đủ điều kiện:**
```json
{
  "success": false,
  "message": "Chu kỳ chưa đủ điều kiện để hoàn thành",
  "data": {
    "analysis": {
      "isComplete": false,
      "phase": "post_peak_tracking",
      "analysis": "Đã qua ngày đỉnh (ngày 15). Cần theo dõi thêm 1 ngày khô để hoàn thành chu kỳ."
    }
  }
}
```

## Logic Phân tích Chu kỳ theo Phương pháp Billings

### Chu kỳ Hoàn chỉnh
Một chu kỳ được coi là hoàn chỉnh khi có đầy đủ các giai đoạn:

1. **Máu kinh nguyệt** (`có máu`)
2. **Lấm tấm máu** (tùy chọn)
3. **Ngày đỉnh** (`trong và âm hộ căng` + `trơn`)
4. **Ít nhất 3 ngày khô** sau ngày đỉnh

### Trường hợp 1: Chu kỳ Bình thường
**Mẫu:** Máu → Lấm tấm máu → Khô → Đục → Trơn, trong âm hộ căng

**Phân tích:**
- Xác định được ngày đỉnh rõ ràng
- Thời gian khô giữa "lấm tấm máu" và "đục" là chu kỳ khô bình thường
- Có thể dự đoán chu kỳ tiếp theo với độ tin cậy cao

### Trường hợp 2: Chu kỳ Cần Theo dõi
**Mẫu:** Lấm tấm máu → Ít chất tiết

**Phân tích:**
- Mẫu chưa rõ ràng, cần theo dõi thêm 2 chu kỳ
- Nếu chu kỳ thứ 2 giống Trường hợp 1 → chuyển sang phân tích bình thường
- Khuyến nghị ghi nhận đầy đủ mỗi ngày

### Dự đoán Chu kỳ Tiếp theo
- Dựa trên ngày đỉnh của chu kỳ hiện tại
- Sử dụng chu kỳ trung bình 28 ngày (có thể điều chỉnh theo lịch sử)
- Cung cấp khoảng dự đoán ±2 ngày

### Khuyến nghị Tự động
- **Chu kỳ bình thường**: Tiếp tục theo dõi đều đặn
- **Chu kỳ cần theo dõi**: Theo dõi thêm 2 chu kỳ
- **Chưa đủ dữ liệu**: Ghi nhận đầy đủ mỗi ngày