# Menstrual Cycle API Documentation

## Tá»•ng quan

API quáº£n lÃ½ chu ká»³ kinh nguyá»‡t theo phÆ°Æ¡ng phÃ¡p Billings, bao gá»“m theo dÃµi 3 chu ká»³, phÃ¢n tÃ­ch dá»¯ liá»‡u, vÃ  gá»­i nháº¯c nhá»Ÿ hÃ ng ngÃ y.

## Authentication

Táº¥t cáº£ endpoints Ä‘á»u yÃªu cáº§u JWT token trong header `Authorization: Bearer <token>`, trá»« endpoint trigger reminder.

## API Endpoints

### 1. Quáº£n lÃ½ Chu ká»³ (Menstrual Cycles)

#### Táº¡o chu ká»³ má»›i
```http
POST /api/menstrual-cycles
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-01"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Táº¡o chu ká»³ má»›i thÃ nh cÃ´ng",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-01T00:00:00.000Z",
    "cycleNumber": 1,
    "status": "tracking",
    "isCompleted": false
  }
}
```

#### Láº¥y danh sÃ¡ch chu ká»³
```http
GET /api/menstrual-cycles?page=1&limit=10&status=tracking
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "cycles": [...],
    "pagination": {
      "current": 1,
      "total": 5,
      "totalRecords": 42
    }
  }
}
```

#### Láº¥y chi tiáº¿t chu ká»³
```http
GET /api/menstrual-cycles/:id
Authorization: Bearer <token>
```

#### Láº¥y dá»¯ liá»‡u calendar
```http
GET /api/menstrual-cycles/calendar?month=1&year=2024
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "month": 1,
    "year": 2024,
    "days": [
      {
        "date": "2024-01-01T00:00:00.000Z",
        "symbol": "M",
        "isPeakDay": false,
        "fertilityProbability": 0,
        "mucusObservation": "cÃ³ mÃ¡u",
        "feeling": "Æ°á»›t",
        "notes": "NgÃ y Ä‘áº§u chu ká»³",
        "isValidated": true,
        "warning": null
      }
    ]
  }
}
```

#### Cáº­p nháº­t chu ká»³
```http
PUT /api/menstrual-cycles/:id
Content-Type: application/json
Authorization: Bearer <token>

{
  "startDate": "2024-01-05",  // Cáº­p nháº­t ngÃ y báº¯t Ä‘áº§u chu ká»³ (tÃ¹y chá»n)
  "endDate": "2024-01-28",    // NgÃ y káº¿t thÃºc chu ká»³ (tÃ¹y chá»n)
  "isCompleted": true,        // ÄÃ¡nh dáº¥u chu ká»³ hoÃ n thÃ nh (tÃ¹y chá»n)
  "status": "completed"       // Tráº¡ng thÃ¡i: "tracking", "completed", "analysis" (tÃ¹y chá»n)
}
```

**LÆ°u Ã½ quan trá»ng vá» startDate:**
- Khi cáº­p nháº­t `startDate`, há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng tÃ­nh toÃ¡n láº¡i `cycleDayNumber` cho táº¥t cáº£ ngÃ y Ä‘Ã£ ghi nháº­n trong chu ká»³
- Äiá»u nÃ y há»¯u Ã­ch khi phÃ¡t hiá»‡n ngÃ y Ä‘áº§u kinh nguyá»‡t thá»±c táº¿ khÃ¡c vá»›i ngÃ y Ä‘Ã£ Ä‘áº·t ban Ä‘áº§u
- VÃ­ dá»¥: Náº¿u báº¡n Ä‘áº·t ngÃ y báº¯t Ä‘áº§u lÃ  15/1 nhÆ°ng sau Ä‘Ã³ nháº­n ra ngÃ y 12/1 má»›i lÃ  ngÃ y Ä‘áº§u tháº­t sá»±

**Response:**
```json
{
  "success": true,
  "message": "Cáº­p nháº­t chu ká»³ thÃ nh cÃ´ng",
  "data": {
    "_id": "cycle_id",
    "createdByUserId": "user_id",
    "startDate": "2024-01-05T00:00:00.000Z",
    "endDate": "2024-01-28T00:00:00.000Z",
    "isCompleted": true,
    "status": "completed"
  }
}
```

### 2. Quáº£n lÃ½ NgÃ y trong Chu ká»³ (Cycle Days)

#### ThÃªm/cáº­p nháº­t dá»¯ liá»‡u ngÃ y
```http
POST /api/cycle-days
Content-Type: application/json
Authorization: Bearer <token>

{
  "cycleId": "cycle_id",
  "date": "2024-01-15",
  "mucusObservation": "trong vÃ  Ã¢m há»™ cÄƒng",
  "feeling": "trÆ¡n",
  "notes": "Cáº£m giÃ¡c cÃ³ thá»ƒ lÃ  ngÃ y X"
}
```

**Mucus Observations:**
- `cÃ³ mÃ¡u`
- `láº¥m táº¥m mÃ¡u`
- `Ä‘á»¥c`
- `Ä‘á»¥c nhiá»u sá»£i`
- `trong nhiá»u sá»£i`
- `trong vÃ  Ã¢m há»™ cÄƒng` (ngÃ y X)
- `dáº§y`
- `Ã­t cháº¥t tiáº¿t`

**Feelings:**
- `Æ°á»›t`
- `dÃ­nh`
- `áº©m`
- `khÃ´`
- `trÆ¡n`

**Response:**
```json
{
  "success": true,
  "message": "Cáº­p nháº­t dá»¯ liá»‡u ngÃ y thÃ nh cÃ´ng",
  "data": {
    "_id": "day_id",
    "cycleId": "cycle_id",
    "date": "2024-01-15T00:00:00.000Z",
    "mucusObservation": "trong vÃ  Ã¢m há»™ cÄƒng",
    "feeling": "trÆ¡n",
    "isPeakDay": true,
    "peakDayRelative": 0,
    "fertilityProbability": 100,
    "isValidated": true,
    "isAutoGenerated": false,
    "cycleDayNumber": 15,
    "month": 1,
    "year": 2024
  }
}
```

#### XÃ³a dá»¯ liá»‡u ngÃ y
```http
DELETE /api/cycle-days/:id
Authorization: Bearer <token>
```

### 3. BÃ¡o cÃ¡o vÃ  PhÃ¢n tÃ­ch

#### Táº¡o bÃ¡o cÃ¡o chu ká»³
```http
POST /api/reports/generate/:cycleId
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Táº¡o bÃ¡o cÃ¡o chu ká»³ thÃ nh cÃ´ng",
  "data": {
    "_id": "report_id",
    "cycleId": "cycle_id",
    "x": "2024-01-15T00:00:00.000Z",
    "xPlusOne": "2024-01-16T00:00:00.000Z",
    "y": "2024-01-28T00:00:00.000Z",
    "result": -12,
    "resultType": "normal",
    "analysis": {
      "peakDayDetected": true,
      "postPeakDaysAnalyzed": 3,
      "fertilityWindowStart": "2024-01-13T00:00:00.000Z",
      "fertilityWindowEnd": "2024-01-18T00:00:00.000Z"
    }
  }
}
```

#### Láº¥y bÃ¡o cÃ¡o chu ká»³
```http
GET /api/reports/:cycleId
Authorization: Bearer <token>
```

#### So sÃ¡nh 3 chu ká»³
```http
GET /api/reports/comparison
Authorization: Bearer <token>
```

### 4. PhÃ¢n tÃ­ch Chu ká»³ HoÃ n chá»‰nh (Cycle Analysis)

#### Láº¥y bÃ¡o cÃ¡o phÃ¢n tÃ­ch chu ká»³
```http
GET /api/menstrual-cycles/:id/analysis
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "Láº¥y bÃ¡o cÃ¡o phÃ¢n tÃ­ch chu ká»³ thÃ nh cÃ´ng",
  "data": {
    "cycleId": "cycle_id",
    "cycleNumber": 1,
    "startDate": "2024-01-01T00:00:00.000Z",
    "endDate": null,
    "isCompleted": false,
    "analysis": {
      "isComplete": false,
      "analysis": "ÄÃ£ cÃ³ kinh nguyá»‡t, Ä‘ang chá» ngÃ y Ä‘á»‰nh (trong vÃ  Ã¢m há»™ cÄƒng).",
      "phase": "pre_peak_tracking",
      "peakDay": null,
      "pattern": {
        "type": "unknown_pattern",
        "name": "Máº«u chÆ°a rÃµ rÃ ng",
        "description": "Cáº§n thÃªm dá»¯ liá»‡u Ä‘á»ƒ phÃ¢n tÃ­ch",
        "confidence": "unknown"
      },
      "nextPeakPrediction": {
        "prediction": null,
        "confidence": "none",
        "message": "ChÆ°a xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c ngÃ y Ä‘á»‰nh cá»§a chu ká»³ hiá»‡n táº¡i"
      },
      "recommendations": [
        "ğŸ“ˆ Cáº§n thÃªm dá»¯ liá»‡u Ä‘á»ƒ phÃ¢n tÃ­ch chu ká»³",
        "ğŸ¯ HÃ£y ghi nháº­n Ä‘áº§y Ä‘á»§ thÃ´ng tin má»—i ngÃ y"
      ]
    }
  }
}
```

**CÃ¡c loáº¡i máº«u chu ká»³ (Pattern Types):**
- `normal_pattern`: Chu ká»³ bÃ¬nh thÆ°á»ng (MÃ¡u â†’ Láº¥m táº¥m mÃ¡u â†’ KhÃ´ â†’ Äá»¥c â†’ Trong Ã¢m há»™ cÄƒng)
- `irregular_pattern`: Chu ká»³ cáº§n theo dÃµi (Láº¥m táº¥m mÃ¡u â†’ Ãt cháº¥t tiáº¿t)
- `unknown_pattern`: Máº«u chÆ°a rÃµ rÃ ng

**CÃ¡c giai Ä‘oáº¡n chu ká»³ (Phases):**
- `no_data`: ChÆ°a cÃ³ dá»¯ liá»‡u
- `initial_tracking`: Äang theo dÃµi ban Ä‘áº§u
- `pre_peak_tracking`: ÄÃ£ cÃ³ kinh nguyá»‡t, chá» ngÃ y Ä‘á»‰nh
- `post_peak_tracking`: ÄÃ£ qua ngÃ y Ä‘á»‰nh, chá» ngÃ y khÃ´
- `completed`: Chu ká»³ hoÃ n chá»‰nh
- `needs_observation`: Cáº§n theo dÃµi thÃªm

#### Tá»± Ä‘á»™ng hoÃ n thÃ nh chu ká»³
```http
POST /api/menstrual-cycles/:id/auto-complete
Authorization: Bearer <token>
```

**Response khi chu ká»³ Ä‘á»§ Ä‘iá»u kiá»‡n:**
```json
{
  "success": true,
  "message": "Chu ká»³ Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u hoÃ n thÃ nh",
  "data": {
    "cycle": {
      "_id": "cycle_id",
      "isCompleted": true,
      "status": "completed",
      "peakDay": "2024-01-15T00:00:00.000Z"
    },
    "analysis": {
      "isComplete": true,
      "analysis": "Chu ká»³ hoÃ n chá»‰nh. NgÃ y Ä‘á»‰nh: 15. Thá»i gian khÃ´ sau Ä‘á»‰nh: 3 ngÃ y."
    }
  }
}
```

**Response khi chu ká»³ chÆ°a Ä‘á»§ Ä‘iá»u kiá»‡n:**
```json
{
  "success": false,
  "message": "Chu ká»³ chÆ°a Ä‘á»§ Ä‘iá»u kiá»‡n Ä‘á»ƒ hoÃ n thÃ nh",
  "data": {
    "analysis": {
      "isComplete": false,
      "phase": "post_peak_tracking",
      "analysis": "ÄÃ£ qua ngÃ y Ä‘á»‰nh (ngÃ y 15). Cáº§n theo dÃµi thÃªm 1 ngÃ y khÃ´ Ä‘á»ƒ hoÃ n thÃ nh chu ká»³."
    }
  }
}
```

## Logic PhÃ¢n tÃ­ch Chu ká»³ theo PhÆ°Æ¡ng phÃ¡p Billings

### Chu ká»³ HoÃ n chá»‰nh
Má»™t chu ká»³ Ä‘Æ°á»£c coi lÃ  hoÃ n chá»‰nh khi cÃ³ Ä‘áº§y Ä‘á»§ cÃ¡c giai Ä‘oáº¡n:

1. **MÃ¡u kinh nguyá»‡t** (`cÃ³ mÃ¡u`)
2. **Láº¥m táº¥m mÃ¡u** (tÃ¹y chá»n)
3. **NgÃ y Ä‘á»‰nh** (`trong vÃ  Ã¢m há»™ cÄƒng` + `trÆ¡n`)
4. **Ãt nháº¥t 3 ngÃ y khÃ´** sau ngÃ y Ä‘á»‰nh

### TrÆ°á»ng há»£p 1: Chu ká»³ BÃ¬nh thÆ°á»ng
**Máº«u:** MÃ¡u â†’ Láº¥m táº¥m mÃ¡u â†’ KhÃ´ â†’ Äá»¥c â†’ TrÆ¡n, trong Ã¢m há»™ cÄƒng

**PhÃ¢n tÃ­ch:**
- XÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c ngÃ y Ä‘á»‰nh rÃµ rÃ ng
- Thá»i gian khÃ´ giá»¯a "láº¥m táº¥m mÃ¡u" vÃ  "Ä‘á»¥c" lÃ  chu ká»³ khÃ´ bÃ¬nh thÆ°á»ng
- CÃ³ thá»ƒ dá»± Ä‘oÃ¡n chu ká»³ tiáº¿p theo vá»›i Ä‘á»™ tin cáº­y cao

### TrÆ°á»ng há»£p 2: Chu ká»³ Cáº§n Theo dÃµi
**Máº«u:** Láº¥m táº¥m mÃ¡u â†’ Ãt cháº¥t tiáº¿t

**PhÃ¢n tÃ­ch:**
- Máº«u chÆ°a rÃµ rÃ ng, cáº§n theo dÃµi thÃªm 2 chu ká»³
- Náº¿u chu ká»³ thá»© 2 giá»‘ng TrÆ°á»ng há»£p 1 â†’ chuyá»ƒn sang phÃ¢n tÃ­ch bÃ¬nh thÆ°á»ng
- Khuyáº¿n nghá»‹ ghi nháº­n Ä‘áº§y Ä‘á»§ má»—i ngÃ y

### Dá»± Ä‘oÃ¡n Chu ká»³ Tiáº¿p theo
- Dá»±a trÃªn ngÃ y Ä‘á»‰nh cá»§a chu ká»³ hiá»‡n táº¡i
- Sá»­ dá»¥ng chu ká»³ trung bÃ¬nh 28 ngÃ y (cÃ³ thá»ƒ Ä‘iá»u chá»‰nh theo lá»‹ch sá»­)
- Cung cáº¥p khoáº£ng dá»± Ä‘oÃ¡n Â±2 ngÃ y

### Khuyáº¿n nghá»‹ Tá»± Ä‘á»™ng
- **Chu ká»³ bÃ¬nh thÆ°á»ng**: Tiáº¿p tá»¥c theo dÃµi Ä‘á»u Ä‘áº·n
- **Chu ká»³ cáº§n theo dÃµi**: Theo dÃµi thÃªm 2 chu ká»³
- **ChÆ°a Ä‘á»§ dá»¯ liá»‡u**: Ghi nháº­n Ä‘áº§y Ä‘á»§ má»—i ngÃ y